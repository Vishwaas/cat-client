<div class="editor-container {classNames}">
  {#if field && field.values}
    {#each field.values as value, index}
      <FieldValueBox 
        isTypeRange
        value={value}
      >
        <button slot="actions" data-toggle="tooltip" title="Delete Value" on:click="deleteValue(index)" class="icon-btn glyphicon glyphicon-remove"></button>
      </FieldValueBox>
    {/each}
    {#if isTypeRange}
       <FieldValueBox 
        isTypeRange
        index={field.values.length + 1}
        bind:value=newValue
        id="safdsf"
      >
        <button slot="actions" data-toggle="tooltip" title="Add Value" on:click="addValue(newValue, index)" class="icon-btn glyphicon glyphicon-plus"></button>
      </FieldValueBox>
      {message}
    {/if}
  {/if}
  <!--
  {#if isTypeRange}
    <button on:click="addNewRangeValue()" class="btn btn-primary add-range-value">
      Add Range Value
      <span class="glyphicon glyphicon-plus-sign"></span>
    </button>
  {/if}
  -->
</div>

<script>
  import ConfigService from "../services/config";
  import FieldValueBox from "./field-value-box.html";
  import Validator from "../utils/validator";
  import { observeDeep } from "svelte-extras";

  function getNewRangeValue(id) {
    return {
      low: " ",
      high: " ",
      desc: " ",
      id: id || null,
      sortOrder: " "
    };
  }

  export default {
    components: { FieldValueBox },

    oncreate() {
      let { field, idCounter } = this.options.data;
      if (!(field.values && field.values.length)) {
        field.values = [];
      }
      idCounter = field.values.length || 1;
      this.set({ field, idCounter });

      // observeDeep.call(this, "field.values.length", () => {
      //   let { idCounter } = this.get();
      //   idCounter++;
      //   this.set({ idCounter });
      // });
    },

    data() {
      return {
        idCounter: 1,
        message: "",
        classNames: "",
        field: {
          values: []
        }
      };
    },
    computed: {
      isTypeRange: ({ field }) => {
        return field && field.type === "Range";
      },
      newValue: ({ idCounter }) => {
        return getNewRangeValue(idCounter);
      }
    },
    methods: {
      deleteValue(index) {
        let { field } = this.get();
        field.values.splice(index, 1);
        this.set({ field });
      },
      addValue(value, index) {
        let { field, idCounter } = this.get();

        if (Validator.isValueValid(value, field.type)) {
          idCounter++;
          field.values.push(value);
          this.set({ message: "", field, idCounter });
        } else {
          this.set({ message: "Invalid Value! Please fill all entries." });
        }
      }
    }
  };
</script>

<style type="text/scss" scoped>
  .add-range-value {
    display: block;
    margin: 0px auto;
  }
</style>