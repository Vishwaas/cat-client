<div class="config-editor">
  <FormField name="Screener">
    <SvelteSelect 
      labelKey="screenName" 
      valueKey="screenId"
      selectedValue={selectedScreener && selectedScreener.screenId || ''}  
      on:change="onScreenerChange(event.option)" 
      options={screeners} 
      prompt="Select Screener"
      isDisabled={!isNew}
    />
  </FormField>
  
  
  {#if selectedScreener && selectedScreener.screenId}
    <FormField classNames="config-name" name="Name">
      <input type="text" class="form-control" bind:value=configuration.desc />
    </FormField>

    {#if configuration && configuration.fields}
      {#each configuration.fields as field, index}
        <div class="field-box-wrapper">
          <FieldBox field={field} />
          <button class="glyphicon glyphicon-edit icon-btn" on:click="showFieldModal(field)" title="Edit Field {field.desc}" ></button>
        </div>
       
      {/each}
    {/if}
    <button on:click="showFieldModal()" class="btn btn-primary add-new-field">
      Add New Field 
      <span class="glyphicon glyphicon-plus-sign"></span>
    </button>

    <div class="editor-actions">
      <button class="btn btn-primary" on:click="saveEditor()">Save</button>
      <button class="btn btn-default" on:click="cancelEditor()">Cancel</button>
    </div>
  {/if}

  {#if showAddField}
    <AddFieldModal selectedScreener={selectedScreener} newField={selectedField} on:notifyFieldSave="updateFieldSave(event.newField, event.isNew)"/>
  {/if}
</div>

<script>
  import FormField from "./form-field.html";
  import ModalWindow from "./modal-window.html";
  import AddFieldModal from "./add-field-modal.html";
  import MultiValueTextBox from "./multivalue-textbox.html";
  import * as sapper from "../../__sapper__/client.js";
  import SvelteSelect from "./svelte-select.html";
  import ConfigService from "../services/config";
  import Validator from "../utils/validator";
  import FieldBox from "./field-box.html";

  export default {
    components: {
      FormField,
      AddFieldModal,
      MultiValueTextBox,
      SvelteSelect,
      FieldBox
    },
    oncreate() {
      let { configuration, isNew, selectedScreener } = this.options.data || {};
      isNew = !(
        configuration &&
        configuration.screenerId &&
        configuration.desc &&
        configuration.fields &&
        configuration.fields.length
      );
      if (!isNew) {
        selectedScreener = {
          screenId: configuration.screenerId
        };
        this.set({ selectedScreener });
      }
      this.set({ isNew });
    },
    data() {
      let screeners = ConfigService.getScreeners();
      return {
        selectedField: {},
        selectedScreener: {},
        screeners,
        isNew: true,
        showAddField: false,
        configuration: {
          screenerId: "",
          desc: "",
          fields: []
        }
      };
    },
    methods: {
      showFieldModal(field) {
        this.set({
          showAddField: true,
          selectedField: field || {}
        });
      },
      onScreenerChange(screener) {
        let { configuration } = this.get();
        configuration.screenerId = screener.screenId;
        this.set({ selectedScreener: screener, configuration });
      },
      updateFieldSave(newField, isNew) {
        if (newField) {
          let { configuration } = this.get();
          if (isNew) {
            configuration.fields.push(newField);
          } else {
            let updatedFieldPosition = -1;
            configuration.fields.some((field, index) => {
              if (field.id === newField.id) {
                updatedFieldPosition = index;
                return false;
              }
            });
            configuration.fields.splice(updatedFieldPosition, 1, newField);
          }

          this.set({ configuration });
        }
        this.set({ showAddField: false });
      },
      deleteField(position) {
        let { configuration } = this.get();

        if (configuration.fields.length === 1) {
          this.root.fire("alert-notification", {
            header: "Error",
            message:
              "Fields cannot be empty. Add another before deleting the last one or delete the configuration"
          });
        } else {
          configuration.fields.splice(position, 1);
          this.set({ configuration });
        }
      },
      saveEditor() {
        let { configuration } = this.get();
        if (!Validator.isConfigValid(configuration)) {
          this.root.fire("alert-notification", {
            header: "Invalid Input",
            message: "Make sure configuration has all data filled."
          });
        } else {
          this.fire("saveConfig", {
            config: configuration
          });
        }
      },
      cancelEditor() {
        sapper.goto("/");
      }
    }
  };
</script>

<style type="text/scss" scoped>
  .form-field-container {
    position: relative;
    padding-right: 50px;
    .icon-btn {
      position: absolute;
      font-size: 3rem;
      right: 0px;
    }
  }

  .add-new-field {
    margin: 0px auto;
    display: block;
  }
  .editor-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
  }
  .editor-actions button {
    margin: 0px 5px;
  }
  .config-name {
    margin-bottom: 30px;
    border-bottom: 0px;
  }
  .field-box-wrapper {
    display: flex;
    justify-content: space-between;
  }
</style>