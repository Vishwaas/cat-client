<div class="config-editor">
  <FormField name="Screeners">
    {#if isNew}
      <SvelteSelect 
        labelKey="screenName" 
        valueKey="screenId"
        selectedValue={selectedScreener}  
        on:change="onScreenerChange(event.option)" 
        options={screeners} 
        prompt="Select Screener"
      />
    {:else}
      <input type="text" class="form-control" value={selectedScreener.screenName} />
    {/if}
  </FormField>
  
  {#if selectedScreener && selectedScreener.screenId}
    <FormField classNames="config-name" name="Name">
      <input type="text" class="form-control" bind:value=configuration.desc />
    </FormField>

    {#if configuration && configuration.fields}
      {#each configuration.fields as field, index}
        <FieldBox field={field} />
      {/each}
    {/if}
    <button on:click="set({showAddField: true})" class="btn btn-primary add-new-field">
      Add New Field 
      <span class="glyphicon glyphicon-plus-sign"></span>
    </button>

    <div class="editor-actions">
      <button class="btn btn-primary" on:click="saveEditor()">Save</button>
      <button class="btn btn-default" on:click="cancelEditor()">Cancel</button>
    </div>
  {/if}

  {#if showAddField}
    <AddFieldModal selectedScreener={selectedScreener} on:notifyFieldAddition="updateFieldAddition(event.newField)"/>
  {/if}
</div>

<script>
  import FormField from "./form-field.html";
  import ModalWindow from "./modal-window.html";
  import AddFieldModal from "./add-field-modal.html";
  import MultiValueTextBox from "./multivalue-textbox.html";
  import * as sapper from "../../__sapper__/client.js";
  import SvelteSelect from "./svelte-select.html";
  import ConfigService from "../services/config";
  import Validator from "../utils/validator";
  import FieldBox from "./field-box.html";

  export default {
    components: {
      FormField,
      AddFieldModal,
      MultiValueTextBox,
      SvelteSelect,
      FieldBox
    },
    data() {
      let screeners = ConfigService.getScreeners();
      return {
        selectedScreener: {},
        screeners,
        showAddField: false,
        configuration: {
          screenerId: "",
          desc: "",
          fields: []
        }
      };
    },
    computed: {
      isNew: ({ configuration }) => {
        return !(
          configuration.desc &&
          configuration.fields &&
          configuration.fields.length
        );
      }
    },
    methods: {
      onScreenerChange(screener) {
        let { configuration } = this.get();
        configuration.screenerId = screener.screenId;
        this.set({ selectedScreener: screener, configuration });
      },
      updateFieldAddition(newField) {
        if (newField) {
          let { configuration } = this.get();
          configuration.fields.push(newField);
          this.set({ configuration });
        }
        this.set({ showAddField: false });
      },
      deleteField(position) {
        let { configuration } = this.get();

        if (configuration.fields.length === 1) {
          this.root.fire("alert-notification", {
            header: "Error",
            message:
              "Fields cannot be empty. Add another before deleting the last one or delete the configuration"
          });
        } else {
          configuration.fields.splice(position, 1);
          this.set({ configuration });
        }
      },
      saveEditor() {
        let { configuration } = this.get();
        if (!Validator.isConfigValid(configuration)) {
          this.root.fire("alert-notification", {
            header: "Invalid Input",
            message: "Make sure configuration has all data filled."
          });
        } else {
          this.fire("saveConfig", {
            config: configuration
          });
        }
      },
      cancelEditor() {
        sapper.goto("/");
      }
    }
  };
</script>

<style type="text/scss" scoped>
  .form-field-container {
    position: relative;
    padding-right: 50px;
    .icon-btn {
      position: absolute;
      font-size: 3rem;
      right: 0px;
    }
  }

  .add-new-field {
    margin: 0px auto;
    display: block;
  }
  .editor-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
  }
  .editor-actions button {
    margin: 0px 5px;
  }
  .config-name {
    margin-bottom: 30px;
    border-bottom: 0px;
  }
</style>